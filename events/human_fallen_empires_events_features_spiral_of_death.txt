namespace = human_fallen_empires_features_spiral_of_death

# start civic 0
country_event = {
	id = human_fallen_empires_features_spiral_of_death.0
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_valid_civic = human_fallen_empires_civic_features_spiral_of_death
		exists = capital_scope
	}

	immediate = {
		human_fallen_empires_effect_init_give_tech_t1 = yes
		human_fallen_empires_effect_init_expand_borders = yes
		set_country_flag = custom_start_screen
		set_country_flag = first_colony
		set_country_flag = Story7
		capital_scope = {
			planet_event = {
				id = human_fallen_empires_init.106
			}
			while = {
				limit = {
					num_pops > 4
				}
				random_tile = {
					limit = {
						exists = pop
						autobuild_trigger_has_planet_capital = no
					}
					kill_pop = yes
					if = {
						limit = {
							has_building = yes
						}
						set_ruined = yes
					}
				}
			}
			while = {
				count = 5
				random_tile = {
					limit = {
						not = {
							exists = pop
						}
					}
					set_blocker = tb_city_ruins
				}
			}
			human_fallen_empires_effect_remove_prescripted_ideal = yes
			every_moon = {
			 	remove_planet = yes
			}
			save_event_target_as = human_fallen_empires_features_spiral_of_death_falling_moon_target
			create_ambient_object = {
				location = root.capital_scope
				type = human_fallen_empires_object_circle
				entity_offset_height = {
					min = -15
					max = -15
				}
				scale = 12
				duration = 0
				entity_face_object = root.capital_scope
			}
			# create_ambient_object = {
				# location = root
				# type = human_fallen_empires_object_features_spiral_of_death_falling_moon
				# entity_offset_height = {
					# min = -15
					# max = -15
				# }
				# entity_face_object = root
			# }
			# last_created_ambient_object = {
				# save_event_target_as = human_fallen_empires_features_spiral_of_death_falling_moon
			# }
			create_country = {
				name = "Falling Moon"
				type = portal_holder
				species = root
				flag = {
					icon = {
						category = blocky
						file = flag_blocky_11.dds
					}
					background = {
						category = backgrounds
						file = 00_solid.dds
					}
					colors = {
						black
						black
						null
						null
					}
				}
				effect = {
					save_event_target_as = human_fallen_empires_features_spiral_of_death_falling_moon_country
					create_fleet = {
						name = "Falling Moon"
						effect = {
							set_owner = prev
							set_location = {
								target = root.capital_scope
								distance = 12
								angle = 0
							}
							save_event_target_as = human_fallen_empires_features_spiral_of_death_falling_moon
							create_ship = {
								design = human_fallen_empires_ship_design_features_spiral_of_death_falling_moon
							}
						}
					}
					every_country = {
						establish_communications_no_message = prev
					}
				}
			}
			planet_event = {
				id = human_fallen_empires_features_spiral_of_death.100
			}
			planet_event = {
				id = human_fallen_empires_features_spiral_of_death.1
				days = 3285 # Nine years
			}
			owner = {
				# random leader killed
				country_event = {
					id = human_fallen_empires_features_spiral_of_death.50
					days = 365
					random = 2000
				}
				# event before planet killed
				country_event = {
					id = human_fallen_empires_features_spiral_of_death.10
					days = 3229
				}
				# event after planet killed
				country_event = {
					id = human_fallen_empires_features_spiral_of_death.11
					days = 3231
				}
			}
		}
	}
}

# kill planet 1
planet_event = {
	id = human_fallen_empires_features_spiral_of_death.1
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				any_owned_pop = {
					exists = owner
					or = {
						has_citizenship_type = {
							type = citizenship_full
						}
						has_citizenship_type = {
							type = citizenship_caste_system
						}
						has_citizenship_type = {
							type = citizenship_organic_trophy
						}
					}
				}
			}
			owner = {
				set_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen
			}
		}
		if = {
			limit = {
				any_owned_pop = {
					exists = owner
					has_citizenship_type = {
						type = citizenship_organic_trophy
					}
				}
			}
			owner = {
				set_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen_organic_trophy
			}
		}
		if = {
			limit = {
				any_owned_pop = {
					exists = owner
					nor = {
						has_citizenship_type = {
							type = citizenship_full
						}
						has_citizenship_type = {
							type = citizenship_caste_system
						}
						has_citizenship_type = {
							type = citizenship_organic_trophy
						}
					}
				}
			}
			owner = {
				set_country_flag = human_fallen_empires_features_spiral_of_death_left_pop
			}
		}
		# create_ambient_object = {
			# type = human_fallen_empires_object_explosion
			# location = this
			# duration = 50
			# use_3d_location = yes
			# entity_scale_to_size = yes
			# scale = 0.5
		# }
		human_fallen_empires_effect_clear_buildings_and_destroy_colony = yes
		change_pc = pc_broken
		orbital_deposit_tile = {
			set_deposit = d_immense_mineral_deposit
		}
		event_target:human_fallen_empires_features_spiral_of_death_falling_moon_country = {
			destroy_country = yes
		}
	}
}

# main story 2 - 50
# before planet killed if lost
country_event = {
	id = human_fallen_empires_features_spiral_of_death.10
	title = human_fallen_empires_features_spiral_of_death.10.name
	desc = {
		trigger = {
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.10.desc.0
				human_fallen_empires_trigger_is_hive = no
			}
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.10.desc.1
				human_fallen_empires_trigger_is_hive = yes
			}
		}
	}
	picture = GFX_evt_exploding_planet
	show_sound = event_red_alert
	location = from
	is_triggered_only = yes

	trigger = {
		exists = from.owner
		from.owner = {
			is_country = root
		}
		num_owned_planets < 2
	}

	option = {
		name = human_fallen_empires_features_spiral_of_death.10.0
		trigger = {
			human_fallen_empires_trigger_is_hive = no
		}
	}
	option = {
		name = human_fallen_empires_features_spiral_of_death.10.1
		trigger = {
			human_fallen_empires_trigger_is_hive = yes
		}
	}
}

# after planet killed if win
country_event = {
	id = human_fallen_empires_features_spiral_of_death.11
	title = human_fallen_empires_features_spiral_of_death.11.name
	desc = {
		trigger = {
			# left nobody or non citizen, robots, for example
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.11.desc.0.0
				owner = {
					human_fallen_empires_trigger_is_hive = no
					not = {
						has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen
					}
				}
			}
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.11.desc.0.1
				owner = {
					human_fallen_empires_trigger_is_hive = yes
					nor = {
						has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen
						has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen_organic_trophy
					}
				}
			}
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.11.desc.0.2
				owner = {
					has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop
				}
			}
			# left citizen
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.11.desc.1.0
				owner = {
					human_fallen_empires_trigger_is_hive = no
					has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen
				}
			}
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.11.desc.1.1
				owner = {
					human_fallen_empires_trigger_is_hive = yes
					has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen
				}
			}
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.11.desc.1.2
				owner = {
					human_fallen_empires_trigger_is_hive = yes
					has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen_organic_trophy
					any_owned_pop = {
						has_citizenship_type = {
							type = citizenship_organic_trophy
						}
					}
				}
			}
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.11.desc.1.3
				owner = {
					human_fallen_empires_trigger_is_hive = yes
					not = {
						any_owned_pop = {
							has_citizenship_type = {
								type = citizenship_organic_trophy
							}
						}
					}
				}
			}
		}
	}
	picture = GFX_evt_exploding_planet
	show_sound = event_super_explosion
	location = from
	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen
			}
			random_list = {
				10 = {
					modifier = {
						factor = 2
						energy > 100
					}
					modifier = {
						factor = 2
						energy > 200
					}
					modifier = {
						factor = 2
						energy > 300
					}
					modifier = {
						factor = 2
						energy > 400
					}
					country_event = {
						id = human_fallen_empires_features_spiral_of_death.14
						days = 365
						random = 360
					}
				}
				20 = {
				}
			}
		}
	}

	option = {
		name = human_fallen_empires_features_spiral_of_death.11.0
		trigger = {
			human_fallen_empires_trigger_is_hive = no
			is_militarist = no
			is_xenophobe = no
			not = {
				has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen
			}
		}
		human_fallen_empires_effect_add_unity.2 = yes
	}
	option = {
		name = human_fallen_empires_features_spiral_of_death.11.1
		trigger = {
			human_fallen_empires_trigger_is_hive = no
			or = {
				is_militarist = yes
				is_xenophobe = yes
			}
			not = {
				has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen
			}
		}
		human_fallen_empires_effect_add_unity.2 = yes
	}
	option = {
		name = human_fallen_empires_features_spiral_of_death.11.2
		trigger = {
			human_fallen_empires_trigger_is_hive = yes
			nor = {
				has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen
				has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen_organic_trophy
			}
		}
		human_fallen_empires_effect_add_unity.2 = yes
	}
	option = {
		name = human_fallen_empires_features_spiral_of_death.11.3
		trigger = {
			human_fallen_empires_trigger_is_hive = no
			has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen
		}
		human_fallen_empires_effect_add_unity.1 = yes
	}
	option = {
		name = human_fallen_empires_features_spiral_of_death.11.4
		trigger = {
			human_fallen_empires_trigger_is_hive = yes
			or = {
				has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen
				has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen_organic_trophy
			}
		}
		human_fallen_empires_effect_add_unity.1 = yes
	}
	option = {
		name = human_fallen_empires_features_spiral_of_death.11.5
		custom_tooltip = human_fallen_empires_features_spiral_of_death.11.5.tooltip
		trigger = {
			human_fallen_empires_trigger_is_hive = no
			or = {
				has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen
				has_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen_organic_trophy
			}
			not = {
				any_owned_pop = {
					has_citizenship_type = {
						type = citizenship_organic_trophy
					}
				}
			}
		}
		human_fallen_empires_effect_add_unity.1 = yes
	}

	after = {
		remove_country_flag = human_fallen_empires_features_spiral_of_death_left_pop
		remove_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen
		remove_country_flag = human_fallen_empires_features_spiral_of_death_left_pop_citizen_organic_trophy
	}
}

# first habitable planet discovered
ship_event = {
	id = human_fallen_empires_features_spiral_of_death.12
	title = human_fallen_empires_features_spiral_of_death.12.name
	desc = {
		trigger = {
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.12.desc.0.0
				human_fallen_empires_trigger_is_hive = no
			}
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.12.desc.0.1
				human_fallen_empires_trigger_is_hive = no
				from = {
					habitability = {
						who = root.owner.species
						value >= 0.8
					}
				}
			}
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.12.desc.0.2
				human_fallen_empires_trigger_is_hive = no
				from = {
					habitability = {
						who = root.owner.species
						value >= 0.5
					}
				}
			}
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.12.desc.0.3
				human_fallen_empires_trigger_is_hive = no
				from = {
					habitability = {
						who = root.owner.species
						value < 0.5
					}
				}
			}
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.12.desc.1
				human_fallen_empires_trigger_is_hive = yes
			}
		}
	}
	picture = {
		trigger = {
			from = {
				is_planet_class = pc_gaia
			}
		}
		picture = GFX_evt_gaia
	}
	picture = {
		trigger = {
			from = {
				is_planet_class = pc_nuked
			}
		}
		picture = GFX_evt_tomb_world
	}
	picture = {
		trigger = {
			from = {
				is_planet_class = pc_arctic
			}
		}
		picture = GFX_evt_arctic
	}
	picture = {
		trigger = {
			from = {
				is_planet_class = pc_arid
			}
		}
		picture = GFX_evt_arid
	}
	picture = {
		trigger = {
			from = {
				is_planet_class = pc_continental
			}
		}
		picture = GFX_evt_continental
	}
	picture = {
		trigger = {
			from = {
				is_planet_class = pc_desert
			}
		}
		picture = GFX_evt_desert
	}
	picture = {
		trigger = {
			from = {
				is_planet_class = pc_ocean
			}
		}
		picture = GFX_evt_ocean
	}
	picture = {
		trigger = {
			from = {
				is_planet_class = pc_tropical
			}
		}
		picture = GFX_evt_tropical
	}
	picture = {
		trigger = {
			from = {
				is_planet_class = pc_tundra
			}
		}
		picture = GFX_evt_tundra
	}
	picture = {
		trigger = {
			always = yes
		}
		picture = GFX_evt_big_landing_ship
	}
	show_sound = event_alien_nature
	location = from
	is_triggered_only = yes

	trigger = {
		exists = owner
		owner = {
			not = {
				has_country_flag = human_fallen_empires_has_event_features_spiral_of_death.12
			}
			has_valid_civic = human_fallen_empires_civic_features_spiral_of_death
		}
		exists = from
		from = {
			habitable_planet = yes
		}
	}

	immediate = {
		owner = {
			set_country_flag = human_fallen_empires_has_event_features_spiral_of_death.12
		}
	}

	option = {
		name = human_fallen_empires_features_spiral_of_death.12.0
		trigger = {
			owner = {
				human_fallen_empires_trigger_is_hive = no
			}
		}
		human_fallen_empires_effect_add_unity.1 = yes
	}
	option = {
		name = human_fallen_empires_features_spiral_of_death.12.1
		trigger = {
			owner = {
				human_fallen_empires_trigger_is_hive = yes
			}
		}
		human_fallen_empires_effect_add_unity.1 = yes
	}
}

# first colony
planet_event = {
	id = human_fallen_empires_features_spiral_of_death.13
	title = progress.3.name
	desc = {
		trigger = {
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.13.desc.0
				owner = {
					human_fallen_empires_trigger_is_hive = no
				}
			}
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.13.desc.1
				owner = {
					human_fallen_empires_trigger_is_hive = yes
				}
			}
		}
	}
	picture = GFX_evt_colony_settlement
	show_sound = event_ship_thrusters
	location = root
	is_triggered_only = yes

	trigger = {
		exists = owner
		owner = {
			not = {
				has_country_flag = human_fallen_empires_has_event_features_spiral_of_death.13
			}
			has_valid_civic = human_fallen_empires_civic_features_spiral_of_death
		}
	}

	immediate = {
		owner = {
			set_country_flag = human_fallen_empires_has_event_features_spiral_of_death.13
		}
	}

	option = {
		name = human_fallen_empires_features_spiral_of_death.13.0
		trigger = {
			owner = {
				human_fallen_empires_trigger_is_hive = no
			}
		}
		owner = {
			human_fallen_empires_effect_add_unity.1 = yes
		}
	}
	option = {
		name = human_fallen_empires_features_spiral_of_death.13.1
		trigger = {
			owner = {
				human_fallen_empires_trigger_is_hive = yes
			}
		}
		owner = {
			human_fallen_empires_effect_add_unity.1 = yes
		}
	}
}

country_event = {
	id = human_fallen_empires_features_spiral_of_death.14
	title = human_fallen_empires_features_spiral_of_death.14.name
	desc = human_fallen_empires_features_spiral_of_death.14.desc
	picture = GFX_evt_colony_settlement
	show_sound = event_ship_thrusters
	location = root
	is_triggered_only = yes

	trigger = {
		exists = ruler
		human_fallen_empires_trigger_is_hive = no
	}

	option = {
		name = human_fallen_empires_features_spiral_of_death.14.0
		ruler = {
			kill_leader = {
				show_notification = no
			}
		}
		human_fallen_empires_effect_add_unity.2 = yes
	}
}

# random events 50 - 100
# random leader killed
country_event = {
	id = human_fallen_empires_features_spiral_of_death.50
	title = human_fallen_empires_features_spiral_of_death.50.name
	desc = {
		trigger = {
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.50.desc.0
				human_fallen_empires_trigger_is_hive = no
			}
			success_text = {
				text = human_fallen_empires_features_spiral_of_death.50.desc.1
				human_fallen_empires_trigger_is_hive = yes
			}
		}
	}
	picture = GFX_evt_colony_settlement
	show_sound = event_administrative_work
	location = root
	is_triggered_only = yes

	trigger = {
		any_owned_leader = {
			not = {
				leader_class = ruler
			}
		}
		not = {
			has_country_flag = human_fallen_empires_has_event_features_spiral_of_death.13
		}
	}

	immediate = {
		random_owned_leader = {
			limit = {
				not = {
					leader_class = ruler
				}
			}
			save_event_target_as = human_fallen_empires_features_spiral_of_death_50_leader
		}
	}

	option = {
		name = human_fallen_empires_features_spiral_of_death.50.0
		trigger = {
			human_fallen_empires_trigger_is_hive = no
		}
		event_target:human_fallen_empires_features_spiral_of_death_50_leader = {
			kill_leader = {
				show_notification = no
			}
		}
	}
	option = {
		name = human_fallen_empires_features_spiral_of_death.50.0
		trigger = {
			human_fallen_empires_trigger_is_hive = yes
		}
		event_target:human_fallen_empires_features_spiral_of_death_50_leader = {
			kill_leader = {
				show_notification = no
			}
		}
	}
}

# find resources

# find pop

